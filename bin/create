#!/bin/bash
action=$1
model=$2

function model {
  model=$1
  file="./data/$model.json"
  if [[ ! -f $file ]]; then
    touch $file
    echo "Created new model: $model"
  else
    echo "Model already exists: $model"
  fi
}

function module {
  model=$1

  module_dir="./server/modules/$model"
  if [[ ! -f $module_dir ]]; then
    mkdir $module_dir
  fi

  module_file="$module_dir/index.js"
  if [[ ! -f $module_file ]]; then
    touch $module_file
    echo "'use strict'

const name = '$model';
const store = require('./stores');
const router = require('./routes');

module.exports = {
  name,
  store,
  router
}" >> $module_file
  fi

  route_file="$module_dir/routes.js"
  if [[ ! -f $route_file ]]; then
    echo "'use strict'

const routes = require('../../routes/shared');
const stores = require('./stores');

module.exports = {
  prefix: '/api/${model}',
  routes: [
    { method: 'get', path: '/download', handler: routes.download(stores) },
    { method: 'get', path: '/', handler: routes.list(stores) },
    { method: 'get', path: '/:id', handler: routes.view(stores) },
    { method: 'post', path: '/', handler: routes.create(stores) },
    { method: 'put', path: '/:id', handler: routes.update(stores) },
    { method: 'delete', path: '/:id', handler: routes.remove(stores) }
  ]
}" >> $route_file
  fi

  store_file="$module_dir/stores.js"
  if [[ ! -f $store_file ]]; then
    echo "'use strict'

const dataAccess = require('../../stores/dataAccess');

const modelClass = '$model';

function list(filters = {}) {
  return dataAccess.list(modelClass, filters);
}

function view(id) {
  return dataAccess.view(modelClass, id);
}

function create(params) {
  return dataAccess.create(modelClass, params);
}

function update(id, params) {
  return dataAccess.update(modelClass, id, params);
}

function remove(id) {
  return dataAccess.remove(modelClass, id);
}

module.exports = {
  modelClass,
  list,
  view,
  create,
  update,
  remove
}" >> $store_file
  fi
}

function client {
  model=$1
  lower_model=$(echo "$model" | tr '[:upper:]' '[:lower:]')

  plugin_dir="./client/src/plugins/${lower_model}"
  index_file="$plugin_dir/index.js"
  view_file="$plugin_dir/view.vue"

  if [[ ! -f $plugin_dir ]]; then
    mkdir $plugin_dir
  fi

  if [[ ! -f $index_file ]]; then
    touch $index_file
    echo "import { useRouter } from 'vue-router'

const route = {
  path: '/${lower_model}',
  name: '${lower_model}',
  component: () => import('./view.vue')
}

const usePlugin = () => {
  return route
}

export default usePlugin" >> $index_file
  fi

  if [[ ! -f $view_file ]]; then
    touch $view_file
    echo "<script setup>
import { onMounted, computed, ref } from 'vue'
import axios from 'axios'

import useConfig from '@/config'
import DataPage from '@/components/DataPage.vue'

const config = useConfig()

const fieldsLayout = ref([
])

const dataFields = computed(() => {
  return [
  ]
})

onMounted(async () => {
})
</script>

<template>
  <DataPage
    data-type=\"${model}\"
    url-base=\"api/${lower_model}\"
    schemas-url-base=\"api/schemas/${lower_model}\"
    :fields-layout=\"fieldsLayout\"
    :data-fields=\"dataFields\"
  />
</template>" >> $view_file
  fi
}

if [[ $action == 'model' ]]; then
  model $model
elif [[ $action == 'module' ]]; then
  module $model
elif [[ $action == 'client' ]]; then
  client $model
fi
